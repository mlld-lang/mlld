>> ralph.mld - autonomous coding agent loop
>> Run once per iteration, or use loop for continuous execution

import { @claude } from "@lib/claude.mld"

>> Load fresh context each iteration
var @plan = <fix_plan.md>
var @specs = <specs/*.md>

>> Classify the most important task
exe @classifyTask(plan) = [
  let @prompt = `Given this plan, identify the SINGLE most important next task:
@plan
Return JSON: { "task": "...", "type": "implement|fix|test", "files": [...] }`
  => @haiku(@prompt) | @parse.llm
]

>> Build context for the task (load only what's relevant)
exe @buildContext(task, specs) = [
  let @relevant = for @spec in @specs
    when @task.type in @spec.mx.relative => @spec
  let @code = for @file in @task.files => <@file>
  => { specs: @relevant, code: @code }
]

>> Execute the task
exe @executeTask(task, context) = [
  let @prompt = `
# Task
@task.task

# Relevant Specs
@context.specs.join("\n\n")

# Current Code
@context.code.join("\n\n")

Implement this task. Search before assuming not implemented.
After implementing, run tests for just this change.
`
  => @claude(@prompt, "sonnet", ".", "Read,Edit,Write,Bash,Grep,Glob")
]

>> Validate with tests
exe @validate() = [
  let @output = cmd { npm test 2>&1 }
  => { pass: @output.exitCode == 0, output: @output }
]

>> Single iteration
var @task = @classifyTask(@plan)
var @context = @buildContext(@task, @specs)
var @result = @executeTask(@task, @context)
var @check = @validate()

when @check.pass => [
  run cmd { git add -A && git commit -m "@task.task" && git push }
  show "committed"
]