>> Async resolution audit (targeted list of interpreter files)

/var @targetFilesText = `
interpreter/utils/variable-resolution.ts
interpreter/utils/field-access.ts
interpreter/eval/expressions.ts
interpreter/eval/exec-invocation.ts
interpreter/eval/var.ts
interpreter/eval/pipeline/unified-processor.ts
interpreter/eval/pipeline/command-execution.ts
interpreter/eval/for.ts
interpreter/eval/foreach.ts
interpreter/eval/when.ts
interpreter/eval/when-expression.ts
interpreter/eval/pipeline/executor.ts
interpreter/utils/auto-unwrap-manager.ts
interpreter/core/interpreter.ts
interpreter/env/Environment.ts
`

/exe @splitList(text) = js {
  if (text === null || text === undefined) return [];
  const value = typeof text === 'string' ? text : String(text);
  if (!value) return [];
  return value
    .split('\n')
    .map(line => line.trim())
    .filter(Boolean);
}
/var @targetFiles = @splitList(@targetFilesText)
/show "Auditing @targetFiles.length files for async/await coverage"

/exe @claude(prompt) = run @prompt | {claude -p --model claude-haiku-4-5}

/exe @analysisPrompt(filePath) = `
You are auditing async behavior in the mlld interpreter.

# Task
Inspect the provided file and catalog every area that:
- Resolves variables, structured values, or executors
- Interacts with Promises (awaiting or not awaiting)
- Spawns parallel work (/for parallel, pipelines, ||) or uses hooks that require resolved values

For each relevant section, determine whether the code already awaits Promises, implicitly relies on auto-await, or risks leaking unresolved Promises. Highlight any areas that need review when enforcing automatic async handling.

# Output JSON shape
{
  "file": "<path>",
  "sections": [
    {
      "name": "function or block",
      "lines": "approx line numbers",
      "awaitStatus": "awaits" | "maybe-await" | "missing-await",
      "notes": "details"
    }
  ],
  "parallelismNotes": ["describe how parallel constructs handle async results"],
  "risks": ["list concrete risks to auto-await coverage"],
  "confidence": 0-100
}

# File: @filePath
<file_content>
<@base/@filePath>
</file_content>

Return ONLY JSON.
`

/var @results = for 15 parallel @file in @targetFiles => @claude(@analysisPrompt(@file)) | @json.llm

/output @results to "@base/tmp/audit-async-resolution.json"
/show "Async resolution audit results written to tmp/audit-async-resolution.json"
