>> Load relevant tests
>> Load pre-screened relevant tests from screening script
/var @relevantTestsData = <@base/relevant-tests.json>
/var @allRelevantDirs = @relevantTestsData.relevantTests

>> Filter for tests that have expected.md (exclude docs smoke tests)
/exe @filterWithExpected(dirs) = node {
  const fs = require('fs');
  const path = require('path');
  return dirs.filter(dir => {
    const expectedPath = path.join(dir, 'expected.md');
    return fs.existsSync(expectedPath);
  });
}

/var @dirsWithExpected = @filterWithExpected(@allRelevantDirs)
>> /show "Filtered to @dirsWithExpected.length tests with expected.md files"

>> Apply limit if set
/var @limit = 40
/exe @applyLimit(dirs, limit) = js {
  const lim = Number(limit) || 0;
  return lim > 0 ? dirs.slice(0, lim) : dirs;
}

/var @testDirs = @applyLimit(@dirsWithExpected, @limit)
/show "Analyzing @testDirs.length directories"

/exe @claude(prompt) = run @prompt | {claude -p --model claude-haiku-4-5}

/exe @request(dir) = `
You are analyzing a test case to categorize its expectations regarding StructuredValue behavior.

<data_contract>
<@base/docs/dev/DATA.md>
</data_contract>

# Test Directory: @dir

<test_input>
<@base/@dir/example.md>
</test_input>

<expected_output>
<@base/@dir/expected.md>
</expected_output>

<task>
Analyze this test case and return a JSON object with the following structure:

{
  "testPath": "@dir",
  "category": "slash" | "feat" | "integration" | "exceptions" | "warnings" | "invalid",
  "expectsStructuredValues": boolean,
  "expectsUnwrappedData": boolean,
  "expectsCtxAccess": boolean,
  "expectsMetadata": boolean,
  "boundaryType": "display" | "computation" | "storage" | "mixed" | "unclear",
  "dataPatterns": {
    "hasArrays": boolean,
    "hasObjects": boolean,
    "hasPrimitives": boolean,
    "hasPipelines": boolean,
    "hasForeach": boolean,
    "hasTemplates": boolean
  },
  "alignment": "aligned" | "misaligned" | "unknown",
  "confidence": 0-100,
  "alignmentNotes": "Brief explanation of alignment with DATA.md",
  "issues": ["List of specific issues if misaligned"]
}

Focus on:
1. Whether expected output shows wrapper leakage (StructuredValue objects in output)
2. Whether test expects .mx property access (metadata flow)
3. What boundary type this test exercises (display/computation/storage)
4. Alignment with DATA.md rules for that boundary type

**Confidence scoring**:
- 90-100: Very confident in analysis
- 70-89: Reasonably confident
- 50-69: Moderate confidence, some ambiguity
- 0-49: Low confidence, should be manually reviewed

**Unknown alignment**: Use when you cannot determine if test expectations align with DATA.md (e.g., insufficient context, edge case, unclear test intent).

Return ONLY valid JSON, no explanatory text.
</task>
`

/var @results = for 40 parallel @dir in @testDirs => @claude(@request(@dir)) | @json.llm | append "progress.log" | log

/output @results to "@base/audit-tests-new.json"
/show "Output to @base/audit-tests-new.json"
