---
description: Audit exact scope of Phase 9 cleanup
author: adam
version: 1.0.0
---

>> Find files that import or use the migration helpers
/show "hello"
/var @fileList = `
interpreter/hooks/taint-post-hook.ts
interpreter/eval/show.ts
interpreter/eval/run.ts
interpreter/env/VariableManager.ts
interpreter/utils/metadata-migration.test.ts
interpreter/eval/import/VariableImporter.ts
interpreter/eval/exec-@invocation.ts
interpreter/utils/metadata-migration.ts
interpreter/eval/directive-inputs.ts
interpreter/eval/var.ts
interpreter/eval/foreach.ts
interpreter/eval/pipeline/executor.ts
core/types/variable/VariableFactories.ts
`
>> /run {rg -l "from.*metadata-migration|metadataToCtx|metadataToInternal" -g "*.ts" -g "!node_modules"}
/show "hi"
>> /var @helperImports = run {rg -l 'from.*metadata-migration|metadataToCtx|metadataToInternal' -g '*.ts' -g '!node_modules'} | @json.fromlist
/var @helperImports = @fileList | @json.fromlist
/show @helperImports

/show "Files importing migration helpers: @helperImports.length"

>> Analyze each file's usage
/exe @analyzeHelperUsage(filepath) = `
Analyze how this file uses migration helpers (metadataToCtx, metadataToInternal).

<file>
Path: @filepath.relative
<content>
<@base/@filepath>
</content>
</file>

<analysis_task>
For each usage of migration helpers:
1. Where is it used? (line number, function name)
2. Why is it used? (converting old format, fallback, etc.)
3. Can it be removed? (if all callers use new format, probably yes)
4. What breaks if removed? (specific impact)
5. What's needed to remove it? (refactor needed or just delete)

Return JSON:
{
  "filepath": "@filepath",
  "importsHelpers": boolean,
  "usageCount": number,
  "usages": [
    {
      "line": number,
      "helper": "metadataToCtx" | "metadataToInternal" | "ctxToSecurityDescriptor" | "etc",
      "context": "brief description of where it's used",
      "purpose": "why it exists",
      "canRemove": boolean,
      "removalStrategy": "just delete" | "refactor needed" | "keep (still needed)",
      "effort": "1min" | "5min" | "15min" | "30min" | "1h",
      "notes": "any special considerations"
    }
  ],
  "summary": "Overall assessment - can helpers be removed from this file?"
}

ONLY return valid JSON.
</analysis_task>
`

/exe @sonnet(request) = run @request | { claude -p --model claude-sonnet-4-5 } 

/show "Analyzing @helperImports.length files..."

/var @analyses = for 10 parallel @file in @helperImports => @sonnet(@analyzeHelperUsage(@file)) | @json.llm | log

/output @analyses to "analyses.txt"

>> Aggregate results
/exe @aggregateAnalysis(analyses) = js {
  const canRemoveAll = analyses.filter(a =>
    a.usages && a.usages.every(u => u.canRemove)
  ).length;

  const needsRefactor = analyses.filter(a =>
    a.usages && a.usages.some(u => u.removalStrategy === 'refactor needed')
  ).length;

  const totalUsages = analyses.reduce((sum, a) => sum + (a.usageCount || 0), 0);

  const effortMinutes = analyses.reduce((sum, a) => {
    if (!a.usages) return sum;
    return sum + a.usages.reduce((s, u) => {
      const effort = u.effort || '0min';
      const mins = effort === '1min' ? 1 : effort === '5min' ? 5 :
                   effort === '15min' ? 15 : effort === '30min' ? 30 :
                   effort === '1h' ? 60 : 0;
      return s + mins;
    }, 0);
  }, 0);

  return {
    totalFiles: analyses.length,
    canRemoveAll,
    needsRefactor,
    totalUsages,
    effortHours: (effortMinutes / 60).toFixed(1),
    effortMinutes
  };
}

/var @summary = @aggregateAnalysis(@analyses)

/output @analyses to "@base/tmp/phase9-scope-detailed.json"
/output @summary to "@base/tmp/phase9-scope-summary.json"

/show "=== Phase 9 Scope Analysis ==="
/show "Files using migration helpers: @summary.totalFiles"
/show "Can remove helpers from all usages: @summary.canRemoveAll files"
/show "Need refactoring: @summary.needsRefactor files"
/show "Total helper usages: @summary.totalUsages"
/show "Estimated effort: @summary.effortHours hours (@summary.effortMinutes minutes)"
/show ""
/show "Detailed analysis: tmp/phase9-scope-detailed.json"
