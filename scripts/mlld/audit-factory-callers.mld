---
description: Audit factory callers to understand Phase 9 scope
author: adam
version: 1.0.0
---

>> Find all Variable factory function calls
/var @factoryPattern = "create.*Variable\\("
/var @factoryFiles = run {rg -l "@factoryPattern" -g '*.ts' -g '!node_modules' -g '!*.test.ts'} | @json.fromlist
/show @factoryFiles

/show "Found @factoryFiles.length files calling factory functions (excluding tests)"

>> Define analysis request
/exe @analyzeFactoryCalls(filepath) = `
Analyze Variable factory calls in this TypeScript file.

<file>
Path: @filepath
<contents>
<@base/@filepath>
</contents>
</file>

<factory_signatures>
Modern factories accept either:
1. OLD FORMAT (VariableMetadata): { security: {...}, isSystem: true, arrayType: '...' }
2. NEW FORMAT (VariableFactoryInitOptions): { ctx: {...}, internal: {...} }

Factory functions to look for:
- createSimpleTextVariable(name, value, source, metadataOrOptions?)
- createInterpolatedTextVariable(name, value, interpolation, source, metadataOrOptions?)
- createObjectVariable(name, value, source, metadataOrOptions?)
- createArrayVariable(name, value, source, metadataOrOptions?)
- createPathVariable(name, path, source, metadataOrOptions?)
- createPrimitiveVariable(name, value, primitiveType, source, metadataOrOptions?)
- And ~10 more...

The 4th parameter is metadataOrOptions.
</factory_signatures>

<analysis_task>
For each factory call in the file:
1. Identify which format is used (old metadata object vs new { ctx, internal })
2. Note complexity (simple metadata vs complex nested)
3. Estimate effort to migrate (trivial/easy/medium/hard)

Return JSON:
{
  "filepath": "@filepath",
  "totalFactoryCalls": number,
  "oldFormat": number,
  "newFormat": number,
  "alreadyMigrated": number,
  "calls": [
    {
      "line": number,
      "function": "createSimpleTextVariable",
      "format": "old" | "new" | "none" | "mixed",
      "complexity": "trivial" | "easy" | "medium" | "hard",
      "snippet": "brief code snippet",
      "migrationEffort": "1min" | "5min" | "15min" | "30min" | "1h",
      "notes": "any special considerations"
    }
  ],
  "summary": "Brief assessment of migration effort for this file"
}

ONLY return valid JSON, no explanations.
</analysis_task>
`

>> Analyze files with Sonnet
/exe @sonnet(request) = run @request | { claude -p --model claude-sonnet-4-5 }

/show "Analyzing @factoryFiles.length files..."

>> Process files in parallel
/var @analyses = for 30 parallel @file in @factoryFiles =>
  @sonnet(@analyzeFactoryCalls(@file)) | @json.llm | log

>> Aggregate results
/exe @aggregateResults(analyses) = js {
  const total = analyses.reduce((sum, a) => sum + a.totalFactoryCalls, 0);
  const oldFormat = analyses.reduce((sum, a) => sum + a.oldFormat, 0);
  const newFormat = analyses.reduce((sum, a) => sum + a.newFormat, 0);

  const byComplexity = {};
  const byEffort = {};

  analyses.forEach(a => {
    a.calls?.forEach(c => {
      byComplexity[c.complexity] = (byComplexity[c.complexity] || 0) + 1;
      byEffort[c.migrationEffort] = (byEffort[c.migrationEffort] || 0) + 1;
    });
  });

  return {
    totalCalls: total,
    oldFormat,
    newFormat,
    alreadyMigrated: total - oldFormat - newFormat,
    byComplexity,
    byEffort,
    filesAnalyzed: analyses.length
  };
}

/var @summary = @aggregateResults(@analyses)

>> Output results
/output @analyses to "@base/tmp/factory-audit-detailed.json"
/output @summary to "@base/tmp/factory-audit-summary.json"

>> Display summary
/show "=== Factory Call Audit Summary ==="
/show "Total factory calls: @summary.totalCalls"
/show "Old format (needs migration): @summary.oldFormat"
/show "New format (already migrated): @summary.newFormat"
/show "Already migrated: @summary.alreadyMigrated"
/show ""
/show "By Complexity:"
/show @summary.byComplexity | @json
/show ""
/show "By Effort:"
/show @summary.byEffort | @json
/show ""
/show "Detailed results: tmp/factory-audit-detailed.json"
/show ""

>> Estimate total effort
/exe @estimateEffort(summary) = js {
  const effort = summary.byEffort || {};
  const minutes =
    (effort['1min'] || 0) * 1 +
    (effort['5min'] || 0) * 5 +
    (effort['15min'] || 0) * 15 +
    (effort['30min'] || 0) * 30 +
    (effort['1h'] || 0) * 60;

  const hours = (minutes / 60).toFixed(1);
  return `Estimated effort: ${hours} hours (${minutes} minutes)`;
}

/show @estimateEffort(@summary)
/show ""
/show "Decision: Worth doing Phase 9 now or defer to later?"
