# mlld

A language for LLMs to speak with machines.

mlld (pronounced "meld") is **not a template language**. It's a scripting language embedded in Markdown documents that enhances them with dynamic content generation while preserving readability.

## Core Syntax Rules

### 1. Directives only at start of lines
mlld syntax is only interpreted in lines that start with a mlld directive:
- ✅ `/var @greeting = "Hello"`
- ❌ `Some text /var @greeting = "Hello"` (directive not at line start)

### 2. Slash for directives, @ for variables
- **Directives use `/`**: `/run`, `/var`, `/show`, `/exe`, etc.
- **Variables use `@`**: Create with `@name`, reference with `@name`
- ❌ `/run/` (trailing slash is invalid)

### 3. Variable creation requires @ prefix
- ✅ `/var @name = "value"` (creates variable `name`)
- ❌ `/var name = "value"` (missing @ on left side)

### 4. Commands use braces or quotes
- ✅ `/run {echo "hello"}` (braces for multi-line)
- ✅ `/run "echo hello @name"` (quotes for single-line)
- ❌ `/run echo "hello"` (missing braces/quotes)

### 4a. In /var assignments, run doesn't use @
- ✅ `/var @result = run {echo "hello"}` (run without @)
- ❌ `/var @result = @run {echo "hello"}` (@ not needed for run in RHS)

### 5. Only /run, /show, and /output produce output
Other directives define or assign but don't output.
- `/run` - executes commands and shows their output
- `/show` - shows content in the document
- `/output` - controls where output goes (stdout, stderr, file)

### 6. Comments use >>
- Start-of-line: `>> This is a comment`
- End-of-line: `/var @name = "Alice" >> This is also a comment`
- Inside templates/strings: `[[Hello >> World]]` - >> is treated as literal text, not a comment

## Basic Examples

```mlld
# Simple variable assignment
/var @author = "Alice"
/var @greeting = "Hello, world!"

>> Comments go at start or end of lines only
# Output content
/show @greeting
/show "Welcome to mlld!"  >> Inline comments too!

# Run commands (quotes for single lines)
/run "echo System info:"
/run "date"

# Or use braces for multi-line commands
/run {
  echo "Multiple commands"
  ls -la
}

# Data structures
/var @config = {
  "name": "my-app",
  "version": "1.0.0",
  "debug": true
}

# Access nested data
/show "App: {{config.name}} v{{config.version}}"
```

## Variables (/var)

The unified `/var` directive creates variables with types inferred from syntax:

```mlld
# Text variables
/var @simple = 'Single quotes = no interpolation'
/var @interpolated = "Hello @name!"
/var @template = `Hello @user, welcome!`

# Data structures
/var @array = [1, 2, 3]
/var @object = {"key": "value"}

# Command results (no @ before run!)
/var @date = run "date"
/var @files = run {ls -la | head -5}

# File content
/var @readme = [README.md]
/var @section = [docs.md # Installation]

# Code execution
/var @result = js { return Math.random() * 100; }
```

## Templates and Interpolation

### Backtick templates (primary - with @ interpolation)
```mlld
/var @message = `Hello @name, welcome to @place!`
/var @link = `[@title](@url)`
```

### Double-bracket templates (fallback - for @ heavy content)
```mlld
/var @tweet = [[Hey {{user}}, check out {{handle}}'s new post!]]
```

### @ interpolation in double quotes
```mlld
/var @greeting = "Hello @name!"    >> @ variables work in double quotes
/run "echo User: @username"         >> Works in quoted commands
/run {echo "Welcome @user.name"}    >> And in brace commands
```

## Exe - Defining Reusable Commands

```mlld
# Command executable
/exe @deploy(env) = run "deploy.sh @env"      >> Single line with quotes
/exe @build(type) = run {                     >> Multi-line with braces
  npm run build:@type
  npm test
}

# Code executable
/exe @calculate(x) = js {return @x * 2}

# Template executable
/exe @greet(name) = `Hello @name!`

# Section executable
/exe @getIntro(file) = [@file # Introduction]

# Environment declaration (shadow functions)
/exe js = { formatDate, parseJSON }
```

## Conditional Logic (/when)

```mlld
# Simple condition
/when @isProduction => /deploy() trust always

# Multiple conditions
/when @env first: [
  "prod" => /show "⚠️ Production Environment"
  "dev" => /show "🔧 Development Environment"
  _ => /show "Unknown environment"
]
```

## Import System

```mlld
# File imports
/import { greeting, config } from "shared.mld"
/import { * } from "utils.mld"

# Module imports (no quotes)
/import { fetchData, parseJSON } from @corp/utils

# Environment variables (must be in mlld.lock.json)
/import { API_KEY, NODE_ENV } from @INPUT
```

## Paths

```mlld
# Simple paths (quoted strings)
/path @docs = "./documentation"
/path @output = "results/output.txt"

# Paths with interpolation (double quotes)
/path @userFile = "data/@username/profile.json"

# Literal paths (single quotes - no interpolation)
/path @template = 'templates/@var-template.html'  // @var is literal text

# Bare resolvers (no quotes)
/import { utils } from @corp/shared-lib

# URLs with caching
/path @api = https://api.example.com/data (5m)
```

## Output Directive

```mlld
# Output to files
/output @content to "output.txt"
/output @data to "config.json"
/output @html to "page.html" as html

# Output to stdout/stderr
/output @message to stdout
/output @error to stderr

# With format specification
/output @config to "settings.yaml" as yaml
```

## Common Patterns

### Running scripts with parameters
```mlld
/exe @test(suite) = run {npm test -- @suite}
/run @test("integration")
```

### Template with many @ symbols
```mlld
# Use [[...]] when you have many @ symbols to escape
/var @twitterTemplate = [[
  Hey @{{handle}}, love your work!
  @{{otherHandle}} you should check this out.
  Reply to this tweet @{{originalAuthor}}
]]
```

### Field access
```mlld
/var @user = { "name": "Alice", "scores": [95, 87, 92] }
/show "Name: @user.name"
/show "First score: @user.scores.0"
```

## Common Mistakes

### ❌ Forgetting braces or quotes in commands
```mlld
/run echo "hello"     # WRONG - needs braces or quotes
/run {echo "hello"}   # CORRECT - braces
/run "echo hello"     # CORRECT - quotes for single line
```

### ❌ Missing @ when creating variables
```mlld
/var greeting = "Hello"  # WRONG - missing @
/var @greeting = "Hello"  # CORRECT
```

### ❌ Using @ for directives
```mlld
@var @greeting = "Hello"  # WRONG - directives use /
/var @greeting = "Hello"  # CORRECT
```

### ❌ Trying to interpolate everywhere
```mlld
Hello @name!  # WRONG - plain text, not interpreted
/show "Hello @name!"  # CORRECT - in directive
/var @msg = `Hello @name!`  # CORRECT - in template
```

## Module-First Philosophy

For complex operations, create modules instead of inline scripts:

### ❌ Overly complex inline mlld
```mlld
/var @results = foreach @processData(@items) | @validate @transform
/when @results.length > 0: [
  true => /var @filtered = foreach @filter(@results)
]
```

### ✅ Better: Use a module
```mlld
/import { processItems } from @myteam/data-utils
/var @results = @processItems(@items)
```

## Common Mistakes with New Syntax

### ❌ Using @run instead of run
```mlld
/var @result = @run {echo "hello"}  # WRONG - no @ before run
/var @result = run {echo "hello"}   # CORRECT
```

### ❌ Using old directive names
```mlld
/text @name = "Alice"     # WRONG - old syntax
/data @config = {}        # WRONG - old syntax
/add @content            # WRONG - old syntax
/exec @cmd = run {ls}    # WRONG - old syntax

/var @name = "Alice"      # CORRECT - unified /var
/var @config = {}         # CORRECT - unified /var
/show @content           # CORRECT - new name
/exe @cmd = run {ls}     # CORRECT - shortened name
```

## Key Concepts

1. **mlld is NOT a template language** - It's a scripting language that only processes lines starting with directives
2. **Everything is explicit** - No magic, no hidden behavior
3. **Markdown-first** - The document should be readable without executing mlld
4. **Module-first for complexity** - Use modules for complex logic
5. **Clear visual distinction** - `/` for commands (directives), `@` for data (variables)
6. **Comments use >>** - Double angle brackets, visually distinct from directives

## Summary of New Syntax

| Old Syntax | New Syntax | Purpose |
|------------|------------|---------|
| `/text @x = "..."` | `/var @x = "..."` | Create any variable |
| `/data @x = {...}` | `/var @x = {...}` | Type inferred from value |
| `/add @content` | `/show @content` | Display content |
| `/exec @cmd(p) = ...` | `/exe @cmd(p) = ...` | Define executable |
| `@run {cmd}` | `run {cmd}` | Run command (no @ in RHS) |