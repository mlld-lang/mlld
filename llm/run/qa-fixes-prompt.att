## Apply Fix: @topic/@experiment

You are implementing a fix for a QA failure based on prior analysis.

## Context

**Topic**: @topic
**Experiment**: @experiment
**Proposed fixes file**: @proposedPath
**Fix to apply**: @fixId

## Your Task

1. Read and understand the proposed fix
2. Create a test case (if one doesn't exist)
3. Implement the fix
4. Verify the fix with tests
5. Update the proposed-fixes.json with results

## Step 1: Understand the Fix

```bash
cat @proposedPath
```

Read the fix with id `@fixId` and understand:
- What code needs to change
- What files are involved
- What the expected behavior should be

## Step 2: Create Test Case

Before implementing, ensure there's a failing test case in `tests/cases/`:

1. Check if a test already exists:
   ```bash
   find tests/cases -name "*.md" | xargs grep -l "pattern-matching-the-issue" 2>/dev/null
   ```

2. If no test exists, create one following this structure:
   ```
   tests/cases/{category}/{test-name}/
   ├── example.md     # Input mlld code
   └── expected.md    # Expected output
   ```

   For invalid/exception tests:
   ```
   tests/cases/{invalid|exceptions}/{test-name}/
   ├── example.md     # Input mlld code
   └── error.md       # Expected error pattern
   ```

3. Run the test to confirm it fails:
   ```bash
   npm run test:case -- {test-path}
   ```

## Step 3: Implement the Fix

Make the necessary code changes. Common locations:
- `grammar/` - Parser/grammar changes
- `interpreter/` - Runtime behavior
- `core/` - Core utilities

After changes, rebuild:
```bash
npm run build
```

## Step 4: Verify

Run the test case:
```bash
npm run test:case -- {test-path}
```

Also run the original experiment:
```bash
mlld @experimentDir/experiment.mld
```

## Step 5: Record Results

Update `@proposedPath` with:

### On Success
Add these fields to the existing JSON:
```json
{
  "fixed": true,
  "fix_applied": "@fixId",
  "test_path": "tests/cases/{path}",
  "changes": ["file1.ts", "file2.ts"]
}
```

### On Failure
Add these fields:
```json
{
  "fixed": false,
  "fix_applied": "@fixId",
  "notes": "Why it failed and what was tried"
}
```

Also create `@experimentDir/fix-attempt-N.json` where N is the attempt number:
```json
{
  "attempt": 1,
  "fix_id": "@fixId",
  "timestamp": "ISO timestamp",
  "changes_made": ["file1.ts:L123", "file2.ts:L456"],
  "test_result": "pass|fail",
  "error": "Error message if failed",
  "notes": "What was tried and learned"
}
```

## Constraints

- Only fix code bugs, not documentation issues
- Don't make unrelated changes
- Ensure all tests pass before marking as fixed
- If the fix is more complex than expected, note it and leave `fixed: false`
- Create atomic commits if you make changes

## Begin

1. Read the proposed fix
2. Create/verify test case exists
3. Implement the fix
4. Verify with tests
5. Update proposed-fixes.json
