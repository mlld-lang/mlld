## Analyze QA Failure: @topic/@experiment

You are analyzing a genuine bug to propose a fix for the QA polish flywheel.

## Context

**Topic**: @topic
**Experiment**: @experiment
**Results file**: @resultsPath
**Reconciliation**: @reconciliationPath

## Your Task

1. **Understand the failure**: Read results.json and reconciliation.json
2. **Deep investigation**: Read mlld source code to find the exact bug
3. **Propose fix(es)**: Concrete implementation with code snippets
4. **Assess confidence + design fit**: Can this be auto-approved?

## Investigation Steps

1. Read the failure and reconciliation:
   ```bash
   cat @resultsPath
   cat @reconciliationPath
   ```

2. Check for experiment script:
   ```bash
   cat @experimentDir/experiment.mld 2>/dev/null || echo "No experiment.mld"
   ```

3. Understand expected behavior:
   ```bash
   mlld howto @topic
   ```

4. Search mlld source for relevant code:
   ```bash
   grep -r "relevant pattern" interpreter/ grammar/
   ```

5. Read specific files to understand the bug

## Design Philosophy Checklist

Before recommending a fix, consider:
- **Consistency**: Does this match how similar features work in mlld?
- **Simplicity**: Is this the minimal fix? Don't over-engineer.
- **Intentional constraints**: Was this perhaps deliberately limited?
- **User impact**: Common use case vs. edge case?

## Output Format

Write `proposed-fix.json` to `@outputDir/`:

```json
{
  "experiment": "@experiment",
  "topic": "@topic",

  "investigation": {
    "root_cause": "Clear description of why this fails",
    "root_cause_location": "interpreter/path/file.ts:123",
    "files_examined": ["file1.ts:10-50", "file2.ts:100-120"]
  },

  "proposed_fixes": [
    {
      "id": "fix-1",
      "description": "Brief description",
      "approach": "Detailed implementation steps",
      "code_changes": [
        {
          "file": "interpreter/path/file.ts",
          "line": 123,
          "before": "existing code",
          "after": "proposed code"
        }
      ],
      "test_changes": {
        "fixture_dir": "tests/cases/feat/<topic>/<experiment>",
        "files": {
          "example.md": "mlld code that exercises the fix",
          "expected.md": "expected output"
        },
        "rationale": "Why this fixture tests the fix"
      },
      "changelog_entry": {
        "section": "Fixed|Added|Changed",
        "text": "**Brief title**: Description of the change"
      },
      "doc_changes": [
        {
          "atom": "docs/src/atoms/<category>/<atom>.md",
          "change": "Description of what to update (if any)"
        }
      ],
      "effort": "trivial|low|medium|high",
      "tradeoffs": "Any risks or side effects"
    }
  ],

  "recommendation": {
    "fix_id": "fix-1",
    "confidence": 0.95,
    "confidence_reasoning": "Exact bug location found, fix is mechanical",
    "design_fit": "high|medium|low",
    "design_fit_reasoning": "Matches how for-loops handle empty arrays",
    "auto_approve": true
  },

  "decision": "fix-1",
  "decision_reasoning": "Safe to auto-approve because..."
}
```

## Auto-Approve Criteria

Set `auto_approve: true` ONLY if ALL are true:
- `confidence >= 0.9` - Exact bug and fix identified
- `design_fit` is "high" or "medium"
- `effort` is "trivial" or "low"
- No breaking changes to existing behavior
- Fix aligns with existing mlld patterns

If ANY doubt, set `auto_approve: false`.

## Field Guidelines

### confidence (0.0-1.0)
- 0.95+: Exact line identified, mechanical fix
- 0.85-0.94: Strong understanding, minor uncertainty
- 0.70-0.84: Good hypothesis, needs verification
- <0.70: Uncertain, needs human review

### design_fit
- **high**: Matches existing patterns exactly
- **medium**: Reasonable addition, consistent with philosophy
- **low**: Works but feels bolted-on, may need design discussion

### effort
- **trivial**: 1-10 lines, obvious change
- **low**: 10-50 lines, straightforward
- **medium**: 50-200 lines, some complexity
- **high**: 200+ lines or architectural changes

### test_changes (REQUIRED for code fixes)

Every code fix MUST have a test fixture. See docs/dev/TESTS.md for full details.

- **fixture_dir**: Place in `tests/cases/feat/<topic>/<experiment>/` for new behavior
- **files**: At minimum `example.md` (input) and `expected.md` (output)
- **example.md**: mlld code that would have failed before the fix, now passes
- **expected.md**: The correct output after the fix
- **Support files**: Prefix with test name to avoid collisions (e.g., `foreach-empty-data.json`)

Example:
```json
"test_changes": {
  "fixture_dir": "tests/cases/feat/foreach/empty-array-handling",
  "files": {
    "example.md": "/var @arr = []\n/foreach @double(@arr)\n",
    "expected.md": ""
  },
  "rationale": "Verifies empty arrays are handled without throwing"
}
```

### changelog_entry (REQUIRED)

Every fix MUST have a changelog entry. Follow Keep a Changelog format.

- **section**: "Fixed" for bug fixes, "Added" for new features, "Changed" for behavior changes
- **text**: Start with bold feature name, then brief description

Example:
```json
"changelog_entry": {
  "section": "Fixed",
  "text": "**Empty array in foreach**: foreach now returns empty array instead of throwing when given empty input"
}
```

### doc_changes (when applicable)

Update docs when the fix changes documented behavior or fixes something the docs got wrong.

- Only update atoms in `docs/src/atoms/` (never edit `docs/llm/*.txt` directly)
- If the bug was caused by docs hallucinating a feature, note which atom needs correction
- If the fix adds/changes behavior, note which atoms describe that behavior
- Set to empty array `[]` if no doc changes needed (pure bug fix with correct docs)

Example:
```json
"doc_changes": [
  {
    "atom": "docs/src/atoms/control-flow/foreach.md",
    "change": "Add note that foreach handles empty arrays by returning empty array"
  }
]
```

## Begin

1. Read failure + reconciliation
2. Investigate source code
3. Propose concrete fix with code snippets
4. Assess confidence and design fit honestly
5. Write proposed-fix.json
