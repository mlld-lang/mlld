>> QA Analysis Orchestrator
>> Usage: mlld run qa-analyze [--topic <filter>] [--limit <n>]
>> Analyzes failed QA experiments and proposes fixes

import { @claude } from @mlld/claude

>> Get filters from payload
import "@payload" as @p
var @topicFilter = @p.topic ? @p.topic : ""
var @limit = @p.limit ? @p.limit : 100

>> Load all results.json files via glob
var @allResults = <@base/qa/**/results.json>

>> Load all proposed-fixes.json to know which are already analyzed
var @alreadyAnalyzed = <@base/qa/**/proposed-fixes.json>

>> Build set of directories that already have proposed fixes
var @analyzedDirs = for @f in @alreadyAnalyzed => @f.mx.absoluteDir

>> Filter to failed experiments without proposed fixes
var @failures = for @r in @allResults
  when @r.status == "fail"
    && !@analyzedDirs.includes(@r.mx.absoluteDir)
    && (@topicFilter == "" || @r.topic.startsWith(@topicFilter))
  => {
    topic: @r.topic,
    experiment: @r.experiment,
    resultsPath: @r.mx.absolute,
    experimentDir: @r.mx.absoluteDir
  }

>> Apply limit
var @toAnalyze = @failures.slice(0, @limit)

>> Load prompt template
var @promptTemplate = <@base/llm/run/qa-analyze-prompt.att>

>> Build prompt by replacing placeholders
exe @buildPrompt(tmpl, failure) = [
  let @s1 = @tmpl.replace("@topic", @failure.topic)
  let @s2 = @s1.replace("@experiment", @failure.experiment)
  let @s3 = @s2.replace("@resultsPath", @failure.resultsPath)
  let @s4 = @s3.replace("@experimentDir", @failure.experimentDir)
  let @outPath = `@failure.experimentDir/proposed-fixes.json`
  => @s4.replace("@outputPath", @outPath)
]

>> Report
show `Found @toAnalyze.length failures to analyze`
when @topicFilter => show `  (filtered by: @topicFilter)`
show ``

>> Process if there's work to do
var @results = for parallel(20) @failure in @toAnalyze [
  let @prompt = @buildPrompt(@promptTemplate, @failure)
  show `Analyzing: @failure.topic/@failure.experiment`
  let @response = @claude(@prompt, "sonnet", @base, "Read,Write,Bash,Glob,Grep") | log
  => `@failure.topic/@failure.experiment`
]

when @results.length > 0 => show ``
when @results.length > 0 => show `Done. Analyzed @results.length experiments.`
when @toAnalyze.length == 0 => show `Nothing to analyze.`
