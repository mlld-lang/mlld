## Apply Fix in Isolated Worktree

You are applying a verified fix to the mlld codebase using git worktrees for isolation.

## Context

**Topic**: @topic
**Experiment**: @experiment
**Base branch**: @baseBranch
**Worktree branch**: polish/@topic-@experiment
**QA directory**: @experimentDir
**Output file**: @experimentDir/fixed.json

## FIRST: Check for Existing Work

Before doing any work, check if this fix was already applied:

```bash
cat @experimentDir/fixed.json 2>/dev/null
```

**If the file exists and shows `applied: true`**, check if the worktree branch exists:
```bash
git branch --list polish/@topic-@experiment
```

If both exist and the fix was verified (`verified: true`), your work is done - exit.
If `verified: false`, the fix needs triage (handled by a separate phase) - exit.

**If fixed.json is missing or incomplete**, proceed with the full apply process below.

## Investigation

- **Root cause**: @rootCause
- **Location**: @rootCauseLocation

## Recommended Fix

- **Fix ID**: @fixId
- **Confidence**: @confidence
- **Design fit**: @designFit

## Proposed Changes

@proposedFixes

## Instructions

### 1. Create Worktree (MANDATORY)

**CRITICAL: You MUST work in a worktree, NOT the main repo.**

Create an isolated worktree for this fix:

```bash
# Remove existing worktree if present (from previous failed run)
wt remove polish/@topic-@experiment -y 2>/dev/null || true

# Create fresh worktree
wt switch --create polish/@topic-@experiment --base @baseBranch -y
```

### 2. Verify You Are In The Worktree

**Do NOT proceed until you confirm you're in the worktree:**

```bash
git branch --show-current
pwd
```

The branch MUST be `polish/@topic-@experiment`. If you're still on `@baseBranch`, STOP and fix the worktree creation.

**If worktree creation fails, write this to @experimentDir/fixed.json and exit:**
```json
{
  "topic": "@topic",
  "experiment": "@experiment",
  "applied": false,
  "merged": false,
  "error": "Failed to create worktree",
  "timestamp": "<ISO timestamp>"
}
```

You are now in the worktree. All file operations happen here, isolated from main.

### 3. Code Changes

For each item in code_changes:
- Read the file first to understand current state
- Apply the change as specified
- If the code has diverged, adapt the fix to current state

### 4. Test Fixture (REQUIRED)

Create the test fixture from test_changes:
- Create the fixture_dir directory
- Create example.md with the mlld input code
- Create expected.md with expected output
- Run: `npm run build:fixtures`

Note: Support file names must be unique across all tests (prefix with test name).

### 5. CHANGELOG.md Entry (REQUIRED)

Add entry to CHANGELOG.md:
- Find the topmost version section (e.g., `## [2.0.0-rc82]`)
- Add under the appropriate subsection (`### Fixed`, `### Added`, `### Changed`)
- Use the changelog_entry text from the fix
- Create subsection if it doesn't exist

### 6. Documentation Updates

If doc_changes is not empty:
- Edit each atom file specified
- Make the described change
- Only edit atoms in `docs/src/atoms/` (never `docs/llm/*.txt` directly)

### 7. Build and Test

```bash
npm run build
npm test
```

Record whether tests pass or fail.

### 8. Commit in Worktree

If tests pass:
```bash
git add .
git commit -m "fix(@topic): <brief description from fix>"
```

If tests fail, still commit so we can inspect:
```bash
git add .
git commit -m "WIP: fix(@topic): <brief description> [tests failing]"
```

Get the commit SHA:
```bash
git rev-parse HEAD
```

### 9. Write Result

Write fixed.json to the QA directory (NOT the worktree). The QA directory is: @experimentDir

```json
{
  "topic": "@topic",
  "experiment": "@experiment",
  "applied": true,
  "verified": <true if all tests pass, false otherwise>,
  "merged": false,
  "worktree_branch": "polish/@topic-@experiment",
  "test_fixture": "<path to created fixture>",
  "changelog_added": true,
  "docs_updated": <true if doc_changes were applied, false if empty>,
  "commit_sha": "<sha from git rev-parse HEAD>",
  "errors": []
}
```

If there were errors, populate the errors array with descriptions.

### 10. Return to Main

Switch back to the base branch:

```bash
wt switch @baseBranch
```

## Important Notes

- All code changes happen in the worktree, NOT the main repo
- fixed.json goes to @experimentDir (in main repo's qa/ dir)
- The worktree will be merged later by a separate merge phase
- Even if tests fail, commit and write fixed.json so we can inspect
- Do NOT delete the worktree - the merge phase will handle that
