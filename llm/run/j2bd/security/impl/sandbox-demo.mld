>>
>> Sandbox Demo: Restricting Agent Capabilities
>>
>> ENFORCEMENT STATUS (as of 2026-02-02):
>> - Tool restrictions: SYNTAX ONLY - not enforced at runtime (ticket m-3ad1)
>> - Filesystem limits: SYNTAX ONLY - not enforced at runtime (ticket m-744d)
>> - Network restrictions: SYNTAX ONLY - not enforced at runtime (ticket m-5e6d)
>> - MCP restrictions: SYNTAX ONLY - not enforced at runtime (ticket m-289d)
>> - Credential protection: ENFORCED via policy label flow rules
>> - Tool attenuation: ENFORCED - child envs cannot expand parent's tool scope
>>
>> Demonstrates environment-based sandboxing for AI agents:
>> 1. Tool restrictions (Read/Write only, no Bash)
>> 2. Filesystem access limits (specific directories only)
>> 3. Network disabled
>> 4. No MCP servers
>> 5. Credential injection via sealed paths
>>

>> ============================================================
>> STEP 1: Configure sandbox environment
>> ============================================================

>> Sandbox with Docker provider for process isolation.
>> Tools limited to Read and Write - Bash is NOT available.
var @sandbox = {
  provider: "@mlld/env-docker",
  tools: ["Read", "Write"],
  fs: { read: [".:/app"], write: ["/tmp"] },
  net: "none",
  mcps: []
}

log "Sandbox config: tools=Read,Write fs.read=.:/app fs.write=/tmp net=none mcps=[]"

>> ============================================================
>> STEP 2: Alternative configs showing different restrictions
>> ============================================================

>> Local execution (no provider) with auth and limited tools.
>> Commands run locally but tool access is restricted.
var @localRestricted = {
  auth: "claude",
  tools: ["Read", "Write"],
  fs: { read: ["@base/**"], write: ["@base/tmp/**", "@base/workspace/**"] }
}

log "Local restricted config: tools=Read,Write fs.write=tmp,workspace"

>> Read-only sandbox - agent can only observe, not modify.
var @readOnly = @sandbox with { tools: ["Read"], fs: { read: [".:/app"], write: [] } }

log "Read-only config derived from sandbox: tools=Read fs.write=[]"

>> Workspace-limited sandbox - agent can only work in /workspace.
var @workspaceSandbox = {
  provider: "@mlld/env-docker",
  tools: ["Read", "Write", "Bash"],
  fs: { read: ["/workspace:/workspace"], write: ["/workspace:/workspace"] },
  net: "none",
  mcps: []
}

log "Workspace sandbox: tools=Read,Write,Bash limited to /workspace"

>> ============================================================
>> STEP 3: Policy with credential configuration
>> ============================================================

>> Define policy with auth credentials.
>> Credentials flow through sealed paths - never exposed as strings.
var @policyConfig = {
  auth: {
    claude: { from: "keychain:mlld-env-myproject/claude", as: "ANTHROPIC_API_KEY" },
    openai: { from: "env:OPENAI_API_KEY", as: "OPENAI_API_KEY" }
  },
  capabilities: {
    allow: ["cmd:git:*", "fs:r:**", "fs:w:@base/tmp/**"],
    deny: ["sh"]
  }
}
policy @p = union(@policyConfig)

log "Policy configured with sealed auth paths"

>> ============================================================
>> STEP 4: Demonstrate environment block usage
>> ============================================================

>> The env block scopes tool access.
>> Inside this block, only Read and Write tools are available.
>> Bash commands would be blocked.

var @demoConfig = { tools: ["Read", "Write"] }

var @envResult = env @demoConfig [
  >> Inside env block, tools are restricted
  log "Inside env block with tools: Read, Write"
  => "env block completed"
]

show @envResult

>> ============================================================
>> STEP 5: Credential injection pattern
>> ============================================================

>> The 'using auth:name' syntax injects credentials as env vars.
>> The secret flows directly from source to env var - never a string.
>>
>> run cmd { claude -p @task } using auth:claude
>>
>> This would inject ANTHROPIC_API_KEY from keychain.
>> The agent cannot read the credential as a string variable.

log "Credential injection uses 'using auth:name' syntax"
log "Example: run cmd { tool } using auth:claude"

>> For explicit variable injection (computed secrets):
>> run cmd { tool } using @token as TOOL_KEY

>> ============================================================
>> SUMMARY
>> ============================================================

show ::

Sandbox Demo Complete
=====================

This demonstrated environment-based agent sandboxing:

1. TOOL RESTRICTIONS (NOT ENFORCED - ticket m-3ad1)
   - tools: ["Read", "Write"] sets tool scope
   - isToolAllowed() exists but is never called during execution
   - WORKAROUND: Use policy capabilities.deny for actual enforcement

2. FILESYSTEM LIMITS (NOT ENFORCED - ticket m-744d)
   - fs.read: [".:/app"] syntax is parsed but not enforced
   - fs.write: ["/tmp"] syntax is parsed but not enforced
   - WORKAROUND: Use policy capabilities for filesystem restrictions
   - Docker provider enforces at container level if used

3. NETWORK DISABLED (NOT ENFORCED - ticket m-5e6d)
   - net: "none" syntax is parsed but not enforced
   - No mlld-level network blocking exists
   - WORKAROUND: Docker provider enforces at container level

4. NO MCP SERVERS (NOT ENFORCED - ticket m-289d)
   - mcps: [] syntax is parsed but not enforced
   - No MCP filtering code exists in the codebase

5. CREDENTIAL INJECTION (ENFORCED)
   - policy.auth defines sealed credential paths
   - 'using auth:name' injects as env var
   - Secret never becomes interpolatable string
   - Policy label flow blocks secret interpolation into commands
   - keychain.get() outputs are labeled 'secret' automatically

Environment configs are composable values:
- Use 'with' to derive restricted variants
- Use 'new' for child environments
- Policy controls overall capabilities

WHAT WORKS NOW:
- Tool attenuation (child cannot expand parent tools)
- Secret label flow protection via policy
- Credential injection via sealed paths
- Policy capabilities.allow/deny

WHAT NEEDS IMPLEMENTATION:
- env-level tool enforcement (call isToolAllowed before exec)
- env-level filesystem enforcement (connect to filesystem-policy)
- env-level network enforcement (new code needed)
- env-level MCP filtering (new code needed)

::
